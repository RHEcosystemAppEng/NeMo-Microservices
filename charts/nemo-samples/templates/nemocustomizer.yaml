{{- if .Values.customizer.enabled }}
apiVersion: apps.nvidia.com/v1alpha1
kind: NemoCustomizer
metadata:
  name: {{ .Values.customizer.name }}
  namespace: {{ .Values.namespace.name }}
spec:
  # Scheduler configuration for training jobs (volcano (default))
  scheduler:
    type: "{{ .Values.customizer.scheduler.type }}"
  # Weights & Biases configuration for experiment tracking
  wandb:
    secretName: {{ .Values.customizer.wandb.secretName }}
    apiKeyKey: {{ .Values.customizer.wandb.apiKeyKey }}
    encryptionKey: {{ .Values.customizer.wandb.encryptionKey }}
  # OpenTelemetry tracing configuration
  otel:
    enabled: {{ .Values.customizer.otel.enabled }}
    exporterOtlpEndpoint: http://customizer-otel-opentelemetry-collector.{{ .Values.namespace.name }}.svc.cluster.local:4317
  # PostgreSQL database connection configuration
  databaseConfig:
    credentials:
      user: {{ .Values.customizer.database.user }}
      secretName: {{ .Values.customizer.database.secretName }}
      passwordKey: {{ .Values.customizer.database.passwordKey }}
    host: nemo-infra-customizer-postgresql.{{ .Values.namespace.name }}.svc.cluster.local
    port: {{ .Values.customizer.database.port }}
    databaseName: {{ .Values.customizer.database.databaseName }}
  # Customizer API service exposure settings
  expose:
    service:
      type: ClusterIP
      port: 8000
  # Global image pull settings used in various subcomponents
  image:
    repository: {{ .Values.customizer.image.repository }}
    tag: {{ .Values.customizer.image.tag | quote }}
    pullPolicy: {{ .Values.customizer.image.pullPolicy }}
    pullSecrets:
      - ngc-secret
  # URL to the NeMo Entity Store microservice
  entitystore:
    endpoint: http://{{ .Values.entitystore.name }}.{{ .Values.namespace.name }}.svc.cluster.local:8000
  # URL to the NeMo Data Store microservice
  datastore:
    endpoint: http://{{ .Values.datastore.name }}.{{ .Values.namespace.name }}.svc.cluster.local:8000
  # URL for MLflow tracking server
  mlflow: 
    endpoint: http://nemo-infra-customizer-mlflow-tracking.{{ .Values.namespace.name }}.svc.cluster.local:80
  # Configuration for the data store CLI tools
  nemoDatastoreTools:
    image: {{ .Values.customizer.datastoreToolsImage.repository }}:{{ .Values.customizer.datastoreToolsImage.tag }}
  # Configuration for model download jobs
  modelDownloadJobs:
    image: "{{ .Values.customizer.image.repository }}:{{ .Values.customizer.image.tag }}"
    ngcAPISecret:
      # Secret that stores NGC API key
      name: {{ .Values.customizer.ngcAPISecret.name }}
      # Key inside secret         
      key: {{ .Values.customizer.ngcAPISecret.key | quote }}
    securityContext:
      fsGroup: 1000
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
     # Time (in seconds) to retain job after completion
    ttlSecondsAfterFinished: 600   
    # Polling frequency to check job status     
    pollIntervalSeconds: 15              
  # Name to the ConfigMap containing model definitions
  modelConfig:
    name: {{ .Values.customizer.modelConfig.name }}
  # Training configuration
  trainingConfig:
    configMap:
      # Optional: Additional configuration to merge into training config
      name: {{ .Values.customizer.trainingConfig.name }}
    # PVC where model artifacts are cached or used during training
    modelPVC:
      create: {{ .Values.customizer.modelPVC.create }}
      name: {{ .Values.customizer.modelPVC.name }}
      # StorageClass for the PVC (can be empty to use default)
      storageClass: {{ .Values.storage.storageClass | quote }}
      volumeAccessMode: {{ .Values.storage.volumeAccessMode }}
      size: {{ .Values.customizer.modelPVC.size }}
    # Workspace PVC automatically created per job
    workspacePVC:
      storageClass: {{ .Values.customizer.workspacePVC.storageClass | quote }}
      volumeAccessMode: {{ .Values.storage.volumeAccessMode }}
      size: {{ .Values.customizer.workspacePVC.size }}
      # Mount path for workspace inside container
      mountPath: {{ .Values.customizer.workspacePVC.mountPath }}
    image:
      repository: {{ .Values.customizer.trainingImage.repository }}
      tag: {{ .Values.customizer.trainingImage.tag | quote }}
    env:
      - name: LOG_LEVEL
        value: INFO                    
    # Multi-node networking environment variables for training (CSPs)
    networkConfig:
      - name: NCCL_IB_SL
        value: "0"
      - name: NCCL_IB_TC
        value: "41"
      - name: NCCL_IB_QPS_PER_CONNECTION
        value: "4"
      - name: UCX_TLS
        value: TCP
      - name: UCX_NET_DEVICES
        value: eth0
      - name: HCOLL_ENABLE_MCAST_ALL
        value: "0"
      - name: NCCL_IB_GID_INDEX
        value: "3"
    # TTL for training job after it completes
    ttlSecondsAfterFinished: 3600       
    # Timeout duration (in seconds) for training job
    timeout: 3600                       
    # Node tolerations
    tolerations:
{{- toYaml .Values.customizer.tolerations | nindent 6 }}
    # Resource requests/limits for training job pods
    # Ephemeral storage prevents eviction during large image pulls
{{- if .Values.customizer.resources }}
    resources:
{{- toYaml .Values.customizer.resources | nindent 6 }}
{{- end }}
{{- end }}

