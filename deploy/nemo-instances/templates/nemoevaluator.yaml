{{- if .Values.evaluator.enabled }}
apiVersion: apps.nvidia.com/v1alpha1
kind: NemoEvaluator
metadata:
  name: {{ .Values.evaluator.name }}
  namespace: {{ .Values.namespace.name }}
spec:
  evaluationImages:
    bigcodeEvalHarness: {{ .Values.evaluator.evaluationImages.bigcodeEvalHarness | quote }}
    lmEvalHarness: {{ .Values.evaluator.evaluationImages.lmEvalHarness | quote }}
    similarityMetrics: {{ .Values.evaluator.evaluationImages.similarityMetrics | quote }}
    llmAsJudge: {{ .Values.evaluator.evaluationImages.llmAsJudge | quote }}
    mtBench: {{ .Values.evaluator.evaluationImages.mtBench | quote }}
    retriever: {{ .Values.evaluator.evaluationImages.retriever | quote }}
    rag: {{ .Values.evaluator.evaluationImages.rag | quote }}
    bfcl: {{ .Values.evaluator.evaluationImages.bfcl | quote }}
    agenticEval: {{ .Values.evaluator.evaluationImages.agenticEval | quote }}
  image:
    repository: {{ .Values.evaluator.image.repository }}
    tag: {{ .Values.evaluator.image.tag | quote }}
    pullPolicy: {{ .Values.evaluator.image.pullPolicy }}
    pullSecrets:
      - ngc-secret
  expose:
    service:
      type: ClusterIP
      port: 8000
  argoWorkflows:
    endpoint: https://nemo-infra-argo-workflows-server.{{ .Values.namespace.name }}.svc.cluster.local:2746
    serviceAccount: {{ .Values.evaluator.argoWorkflows.serviceAccount }}
  vectorDB:
    endpoint: http://milvus.{{ .Values.namespace.name }}.svc.cluster.local:19530
  datastore:
    endpoint: http://{{ .Values.datastore.name }}.{{ .Values.namespace.name }}.svc.cluster.local:8000/v1/hf
  entitystore:
    endpoint: http://{{ .Values.entitystore.name }}.{{ .Values.namespace.name }}.svc.cluster.local:8000
  databaseConfig:
    host: nemo-infra-evaluator-postgresql.{{ .Values.namespace.name }}.svc.cluster.local
    port: {{ .Values.evaluator.database.port }}
    databaseName: {{ .Values.evaluator.database.databaseName }}
    credentials:
      user: {{ .Values.evaluator.database.user }}
      secretName: {{ .Values.evaluator.database.secretName }}
      passwordKey: {{ .Values.evaluator.database.passwordKey }}
  otel:
    enabled: {{ .Values.evaluator.otel.enabled }}
    exporterOtlpEndpoint: http://evaluator-otel-opentelemetry-collector.{{ .Values.namespace.name }}.svc.cluster.local:4317
{{- if .Values.evaluator.env }}
  env:
{{- range .Values.evaluator.env }}
    - name: {{ .name }}
      {{- if eq .name "NIM_PROXY_URL" }}
      # Automatically construct NIM service URL
      # For NIM (OpenShift AI) deployments:
      # - Service name should include -predictor suffix (e.g., meta-llama3-1b-instruct-predictor)
      # - URL should include /v1 path
      # - Namespace might be different from NeMo namespace
      {{- $nimServiceName := "meta-llama3-1b-instruct" }}
      {{- $nimServiceSuffix := "" }}
      {{- $nimNamespace := $.Values.namespace.name }}
      {{- $nimPath := "" }}
      {{- if hasKey $.Values.evaluator "nimProxy" }}
        {{- if hasKey $.Values.evaluator.nimProxy "serviceName" }}
          {{- if ne $.Values.evaluator.nimProxy.serviceName "" }}
            {{- $nimServiceName = $.Values.evaluator.nimProxy.serviceName }}
          {{- end }}
        {{- end }}
        {{- if hasKey $.Values.evaluator.nimProxy "serviceSuffix" }}
          {{- if ne $.Values.evaluator.nimProxy.serviceSuffix "" }}
            {{- $nimServiceSuffix = $.Values.evaluator.nimProxy.serviceSuffix }}
          {{- end }}
        {{- end }}
        {{- if hasKey $.Values.evaluator.nimProxy "namespace" }}
          {{- if ne $.Values.evaluator.nimProxy.namespace "" }}
            {{- $nimNamespace = $.Values.evaluator.nimProxy.namespace }}
          {{- end }}
        {{- end }}
        {{- if hasKey $.Values.evaluator.nimProxy "path" }}
          {{- if ne $.Values.evaluator.nimProxy.path "" }}
            {{- $nimPath = $.Values.evaluator.nimProxy.path }}
          {{- end }}
        {{- end }}
      {{- end }}
      value: "http://{{ $nimServiceName }}{{ $nimServiceSuffix }}.{{ $nimNamespace }}.svc.cluster.local:8000{{ $nimPath }}"
      {{- else }}
      value: {{ .value | quote }}
      {{- end }}
{{- end }}
{{- end }}
  replicas: {{ .Values.evaluator.replicas }}
{{- end }}

